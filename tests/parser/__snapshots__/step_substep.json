{
  "type": "Root",
  "block": {
    "type": "Block",
    "statements": [
      {
        "type": "Step",
        "id": "pipeline",
        "desc": "Root pipeline",
        "output": "pipelineResult",
        "block": {
          "type": "Block",
          "statements": [
            {
              "type": "Action",
              "module": "var",
              "args": {
                "value": {
                  "numbers": []
                }
              },
              "output": "prepareResult"
            },
            {
              "type": "Action",
              "module": "var",
              "args": {
                "value": {
                  "sum": 0
                }
              },
              "output": "aggregateResult"
            },
            {
              "type": "Action",
              "module": "var",
              "args": {
                "value": {
                  "message": "pending"
                }
              },
              "output": "reportResult"
            },
            {
              "type": "Action",
              "module": "var",
              "args": {
                "value": {
                  "status": "pending"
                }
              },
              "output": "finalizeResult"
            },
            {
              "type": "Action",
              "module": "var",
              "args": {
                "value": 0
              },
              "output": "total"
            },
            {
              "type": "Step",
              "id": "prepare",
              "desc": "Prepare data",
              "output": "prepareResult",
              "block": {
                "type": "Block",
                "statements": [
                  {
                    "type": "Action",
                    "module": "var",
                    "args": {
                      "value": [
                        1,
                        2
                      ]
                    },
                    "output": "numbers"
                  },
                  {
                    "type": "Set",
                    "target": "total",
                    "expression": {
                      "type": "Literal",
                      "value": 0
                    }
                  },
                  {
                    "type": "Return",
                    "entries": [
                      {
                        "key": "numbers",
                        "expression": {
                          "type": "Identifier",
                          "name": "numbers"
                        }
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Step",
              "id": "aggregate",
              "desc": "Sum aggregation",
              "output": "aggregateResult",
              "block": {
                "type": "Block",
                "statements": [
                  {
                    "type": "Each",
                    "iterator": "n",
                    "iterable": "numbers",
                    "block": {
                      "type": "Block",
                      "statements": [
                        {
                          "type": "Action",
                          "module": "math",
                          "args": {
                            "__options": [
                              "add"
                            ],
                            "op": "add",
                            "a": "total",
                            "b": "n"
                          },
                          "output": "total"
                        },
                        {
                          "type": "If",
                          "condition": {
                            "type": "Simple",
                            "left": "total",
                            "comparator": ">",
                            "right": 6,
                            "negated": false
                          },
                          "thenBlock": {
                            "type": "Block",
                            "statements": [
                              {
                                "type": "Action",
                                "module": "math",
                                "args": {
                                  "__options": [
                                    "add"
                                  ],
                                  "op": "add",
                                  "a": "total",
                                  "b": 0
                                },
                                "output": "partial"
                              },
                              {
                                "type": "Return",
                                "entries": [
                                  {
                                    "key": "sum",
                                    "expression": {
                                      "type": "Identifier",
                                      "name": "partial"
                                    }
                                  }
                                ]
                              }
                            ]
                          }
                        }
                      ]
                    }
                  },
                  {
                    "type": "Return",
                    "entries": [
                      {
                        "key": "sum",
                        "expression": {
                          "type": "Identifier",
                          "name": "total"
                        }
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Step",
              "id": "validate",
              "desc": "Validation / retry",
              "onError": "continue",
              "block": {
                "type": "Block",
                "statements": [
                  {
                    "type": "If",
                    "condition": {
                      "type": "Simple",
                      "left": "total",
                      "comparator": "<",
                      "right": 6,
                      "negated": false
                    },
                    "thenBlock": {
                      "type": "Block",
                      "statements": [
                        {
                          "type": "Action",
                          "module": "print",
                          "args": {
                            "__entries": [
                              {
                                "kind": "literal",
                                "value": "Total too small, restarting"
                              }
                            ],
                            "__suppressStore": true
                          },
                          "output": "__print_dummy_0"
                        },
                        {
                          "type": "Action",
                          "module": "var",
                          "args": {
                            "value": [
                              1,
                              2,
                              3,
                              4
                            ]
                          },
                          "output": "expanded"
                        },
                        {
                          "type": "Set",
                          "target": "numbers",
                          "expression": {
                            "type": "Identifier",
                            "name": "expanded"
                          }
                        },
                        {
                          "type": "Set",
                          "target": "total",
                          "expression": {
                            "type": "Literal",
                            "value": 0
                          }
                        },
                        {
                          "type": "Jump",
                          "targetStepId": "aggregate"
                        }
                      ]
                    }
                  }
                ]
              }
            },
            {
              "type": "Step",
              "id": "report",
              "desc": "Write report",
              "output": "reportResult",
              "block": {
                "type": "Block",
                "statements": [
                  {
                    "type": "Action",
                    "module": "print",
                    "args": {
                      "__entries": [
                        {
                          "kind": "literal",
                          "value": "Total sum:"
                        },
                        {
                          "kind": "identifier",
                          "name": "total"
                        }
                      ],
                      "__suppressStore": true
                    },
                    "output": "__print_dummy_1"
                  },
                  {
                    "type": "Return",
                    "entries": [
                      {
                        "key": "message",
                        "expression": {
                          "type": "Literal",
                          "value": "done"
                        }
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Step",
              "id": "finalize",
              "desc": "Finalize",
              "output": "finalizeResult",
              "block": {
                "type": "Block",
                "statements": [
                  {
                    "type": "Action",
                    "module": "print",
                    "args": {
                      "__entries": [
                        {
                          "kind": "literal",
                          "value": "Final total:"
                        },
                        {
                          "kind": "identifier",
                          "name": "total"
                        }
                      ],
                      "__suppressStore": true
                    },
                    "output": "__print_dummy_2"
                  },
                  {
                    "type": "Action",
                    "module": "math",
                    "args": {
                      "__options": [
                        "add"
                      ],
                      "op": "add",
                      "a": "total",
                      "b": 0
                    },
                    "output": "finalTotal"
                  },
                  {
                    "type": "Return",
                    "entries": [
                      {
                        "key": "status",
                        "expression": {
                          "type": "Literal",
                          "value": "ok"
                        }
                      },
                      {
                        "key": "value",
                        "expression": {
                          "type": "Identifier",
                          "name": "finalTotal"
                        }
                      }
                    ]
                  }
                ]
              }
            },
            {
              "type": "Return",
              "entries": [
                {
                  "key": "prepared",
                  "expression": {
                    "type": "Identifier",
                    "name": "prepareResult"
                  }
                },
                {
                  "key": "aggregate",
                  "expression": {
                    "type": "Identifier",
                    "name": "aggregateResult"
                  }
                },
                {
                  "key": "report",
                  "expression": {
                    "type": "Identifier",
                    "name": "reportResult"
                  }
                },
                {
                  "key": "finalize",
                  "expression": {
                    "type": "Identifier",
                    "name": "finalizeResult"
                  }
                }
              ]
            }
          ]
        }
      },
      {
        "type": "Step",
        "id": "final",
        "desc": "Print results",
        "block": {
          "type": "Block",
          "statements": [
            {
              "type": "Action",
              "module": "print",
              "args": {
                "__entries": [
                  {
                    "kind": "literal",
                    "value": "pipeline:"
                  },
                  {
                    "kind": "identifier",
                    "name": "pipelineResult"
                  }
                ],
                "__suppressStore": true
              },
              "output": "__print_dummy_3"
            },
            {
              "type": "Action",
              "module": "print",
              "args": {
                "__entries": [
                  {
                    "kind": "literal",
                    "value": "prepare:"
                  },
                  {
                    "kind": "identifier",
                    "name": "prepareResult"
                  }
                ],
                "__suppressStore": true
              },
              "output": "__print_dummy_4"
            },
            {
              "type": "Action",
              "module": "print",
              "args": {
                "__entries": [
                  {
                    "kind": "literal",
                    "value": "aggregate:"
                  },
                  {
                    "kind": "identifier",
                    "name": "aggregateResult"
                  }
                ],
                "__suppressStore": true
              },
              "output": "__print_dummy_5"
            },
            {
              "type": "Action",
              "module": "print",
              "args": {
                "__entries": [
                  {
                    "kind": "literal",
                    "value": "report:"
                  },
                  {
                    "kind": "identifier",
                    "name": "reportResult"
                  }
                ],
                "__suppressStore": true
              },
              "output": "__print_dummy_6"
            }
          ]
        }
      }
    ]
  }
}
