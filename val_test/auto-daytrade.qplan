plan {
  @title "자동 단타 기본 플로우"
  @summary "장 시작 여부 확인 → 추천 종목 수집 → 거래 모니터 등록 → 상태 요약"
  @since "자동 단타 플로우 초안"

  step id="market_guard" desc="장/휴장 가드" type="action" onError="continue" {

    market_holiday_calendar -> holidays
    var "" -> exitReason
    chat_output text=holidays kind="log"
    if holidays.count > 0 {
      set exitReason = "오늘은 휴장입니다."
      jump to="summary"
    }
  }
  step id="broker" desc="브로커 연결/장 상태" type="action" onError="continue" {
    broker_market_status -> brokerStatus
    if brokerStatus.isConnected == false {
      set exitReason = "증권사 연결이 필요합니다."
      jump to="summary"
    }
  }
  step id="precheck_log" desc="사전 점검 로그" type="action" onError="continue" {
    chat_output text=holidays kind="log"
    chat_output text=brokerStatus kind="log"
  }
  step id="positions" desc="현재 보유 종목 확인" type="action" onError="continue" {
    broker_positions -> positions
  }
  step id="screen_recomm" desc="후보 종목 수집 및 등록" type="action" onError="continue" {
    chat_output text="[AT] 서버 추천/스크리닝 종목 수집 시작" kind="log"
    
    // 1. 서버 추천 조회
    recomm_daily horizon="DAYTRADE" universeId="ALL" -> recommResult
    
    // 변수 초기화
    var "" -> msg
    set msg = "서버 추천: " + recommResult.count + "개 발견"
    chat_output text=msg
    
    // 변수 초기화
    var "" -> candidates
    var 0 -> count
    
    set candidates = recommResult.items
    
    // 2. 서버 추천 없으면(0개이면) 키움 실시간 발굴 (백업)
    set count = recommResult.count
    if count == 0 {
      chat_output text="[AT] 서버 데이터 0개. 키움 실시간 발굴 시도" kind="log"
      broker_daytrade_candidates mrkt_tp="000" limit=30 -> brokerResult
      set candidates = brokerResult.watchlist
    } else {
       // 이미 candidates가 채워져 있음 (recommResult.items)
       if candidates == null {
          // 방어 코드
          broker_daytrade_candidates mrkt_tp="000" limit=30 -> brokerResult
          set candidates = brokerResult.watchlist
       }
    }
    
    // 3. 일단 발견된 모든 종목을 거래 모니터에 등록 (상태: planned)
    //    필터링은 루프 돌면서 수행
    trade_watch_sync watchlist=candidates status="planned" note="auto-daytrade" autoManaged=true prune=true
    
    var "" -> msg
    set msg = "모니터링 등록 완료: " + candidates.count + "종목"
    chat_output text=msg
    
    chat_output text="[AT] 등록된 후보 목록:" kind="log"
    each item in candidates {
      var "" -> label
      set label = item.symbol
      if item.stockCode != null {
        set label = item.stockCode
      }
      if item.name != null {
         set label = item.name + "(" + label + ")"
      }
      chat_output text=label kind="log"
    }
  }

  step id="watch_list" desc="거래 모니터 목록 확인" type="action" onError="continue" {
    trade_watch_list -> tradeWatch
  }

  step id="check_time" desc="장시작시간 확인 중" type="action" onError="stop" {
    market_time_status -> marketTime
    var "프리마켓 오픈?:" + marketTime.isPreMarket -> chat_msg
    chat_output text=chat_msg kind="log"

    while marketTime.isPreMarket == false {
      sleep ms=100
      var "프리마켓 오픈?:" + marketTime.isPreMarket -> chat_msg
      chat_output text=chat_msg kind="log"
      market_time_status -> marketTime
    }
    chat_output text="장 시작시간이 확인되었습니다." kind="log"
  }
  
  step id="auto_start" desc="자동거래 엔진 시작" type="action" onError="continue" {
    auto_trade_start
  }

  step id="summary" desc="결과 요약" type="action" onError="continue" {
    if exitReason != "" {
      chat_output text=exitReason
    }
    if exitReason == "" {
      chat_output text="자동 단타 플로우가 시작되었습니다."
    }
  }
}
