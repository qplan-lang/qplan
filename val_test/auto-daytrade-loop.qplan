plan {
  @title "자동 단타 루프"
  @summary "거래 모니터 기반 매수/매도 판단 및 보유 경고"
  @since "자동거래 루프"

  step id="market_guard" desc="장/휴장 확인" type="action" onError="continue" {
    market_time_status -> marketTime
    market_holiday_calendar -> holidays
    var "" -> exitReason
    if holidays.count > 0 {
      set exitReason = "오늘은 휴장입니다."
      jump to="summary"
    }
    if marketTime.isMarketHours == false {
      set exitReason = "장 시간이 아닙니다."
      jump to="summary"
    }
  }

  step id="settings" desc="자동거래 설정" type="action" onError="continue" {
    auto_trade_settings_get -> settings
  }

  step id="now" desc="현재 시간" type="action" onError="continue" {
    auto_trade_now -> now
  }

  step id="trade_loop" desc="거래 판단 루프" type="action" onError="continue" {
    trade_watch_list -> tradeWatch
    
    each item in tradeWatch.items {
      // 기본 필터링: status, autoManaged, pending 체크
      if item.status != "planned" {
        if item.status != "active" {
          continue
        }
      }
      if item.autoManaged == false {
        continue
      }
      if item.pendingOrder != null {
        continue
      }
      if item.llmCooldownUntil != null {
        if item.llmCooldownUntil > now.now {
          continue
        }
      }

      // 보유 수량 조회 및 업데이트
      auto_trade_get_holding stockCode=item.symbol -> holding
      trade_watch_update stockCode=item.symbol holdingQty=holding.qty holdingAvg=holding.avg

      // 보유 중이 아니면 거래 쿨다운 체크
      if holding.qty == 0 {
        if item.tradeCooldownUntil != null {
          if item.tradeCooldownUntil > now.now {
            continue
          }
        }
      }

      // 매수/매도 모드 결정
      var "buy" -> mode
      if holding.qty > 0 {
        set mode = "sell"
      }

      // 통합 분석 및 판단 (TypeScript가 모든 로직 수행)
      auto_trade_analyze_and_decide 
        mode=mode 
        stockCode=item.symbol 
        stockName=item.name 
        holdingQty=holding.qty 
        holdingAvg=holding.avg 
        useLlm=settings.useLlmConfirmation
        -> decision

      var "" -> label
      set label = item.symbol
      if item.name != null {
        set label = item.name + "(" + item.symbol + ")"
      }

      // HOLD: 거래 안 함
      if decision.action == "HOLD" {
        var "" -> msg
        set msg = label + ": " + decision.reason
        chat_output text=msg
        var 0 -> cooldownUntil
        set cooldownUntil = now.now + 60000
        trade_watch_update stockCode=item.symbol llmCooldownUntil=cooldownUntil
        continue
      }

      // 현재가 검증
      if decision.quote == null {
        var "" -> msg
        set msg = "[경고] " + label + " 현재가 정보 없음"
        chat_output text=msg
        continue
      }

      // 통합 실행 (승인 처리 포함, TypeScript가 모든 로직 수행)
      auto_trade_execute 
        decision=decision 
        stockCode=item.symbol 
        stockName=item.name 
        holdingQty=holding.qty 
        maxTradeAmount=settings.maxTradeAmount 
        -> result

      chat_output text=result.message

      // 승인 대기인 경우 쿨다운 설정
      if result.needsApproval == true {
        var 0 -> cooldownUntil
        set cooldownUntil = now.now + settings.llmCooldownMs
        trade_watch_update stockCode=item.symbol llmCooldownUntil=cooldownUntil
      }
    }
  }

  step id="summary" desc="루프 요약" type="action" onError="continue" {
    if exitReason != "" {
      chat_output text=exitReason
    }
  }
}
